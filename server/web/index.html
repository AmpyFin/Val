<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AmpyFin â€” Val Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN for quick styling; remove if you want local CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="px-6 py-4 border-b bg-white sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-semibold">ðŸ“ˆ AmpyFin â€” Val Model</h1>
      <div id="generated" class="text-sm text-slate-500">loadingâ€¦</div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-4">
    <!-- Controls -->
    <section class="bg-white p-4 rounded-2xl shadow-sm border">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium mb-1">MoS threshold</label>
          <input id="mos" type="range" min="0" max="0.8" step="0.05" value="0.20" class="w-full">
          <div class="text-sm"><span id="mosVal">20</span>%</div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Show undervalued only</label>
          <input id="uvOnly" type="checkbox" class="h-4 w-4 align-middle"> <span class="text-sm">â‰¥ MoS</span>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Sort by</label>
          <select id="sortBy" class="w-full border rounded-lg p-2">
            <option value="best_mos">best_mos</option>
            <option value="price">price</option>
            <option value="best_fair_value">best_fair_value</option>
            <option value="ticker">ticker</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Ascending</label>
          <input id="asc" type="checkbox" class="h-4 w-4 align-middle">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Limit rows</label>
          <input id="limit" type="number" min="5" max="5000" step="5" value="50" class="w-full border rounded-lg p-2">
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="bg-white p-4 rounded-2xl shadow-sm border">
      <div class="flex items-center justify-between mb-2">
        <div id="summary" class="text-sm text-slate-600">â€“</div>
        <div class="space-x-2">
          <button id="downloadCsv" class="px-3 py-2 rounded-lg border hover:bg-slate-100 text-sm">Download CSV</button>
          <button id="refreshBtn" class="px-3 py-2 rounded-lg border hover:bg-slate-100 text-sm">Refresh</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left border-b">
            <tr class="text-slate-500">
              <th class="py-2 pr-4">Ticker</th>
              <th class="py-2 pr-4 text-right">Price</th>
              <th class="py-2 pr-4 text-right">Fair Value</th>
              <th class="py-2 pr-4 text-right">MoS</th>
              <th class="py-2 pr-4">Strategy</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    let payload = null;     // latest JSON from /results
    let filtered = [];      // filtered/sorted rows

    const els = {
      mos: document.getElementById('mos'),
      mosVal: document.getElementById('mosVal'),
      uvOnly: document.getElementById('uvOnly'),
      sortBy: document.getElementById('sortBy'),
      asc: document.getElementById('asc'),
      limit: document.getElementById('limit'),
      rows: document.getElementById('rows'),
      summary: document.getElementById('summary'),
      generated: document.getElementById('generated'),
      refreshBtn: document.getElementById('refreshBtn'),
      downloadCsv: document.getElementById('downloadCsv'),
    };

    function fmtMoney(x){ return x==null ? "-" : Number(x).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function fmtPct(x){ return x==null ? "-" : (100*Number(x)).toFixed(1)+"%"; }

    function applyFilters(){
      if(!payload) return;
      const minMos = parseFloat(els.mos.value || "0.2");
      const uvOnly = els.uvOnly.checked;
      let rows = (payload.tickers || []).slice();

      // Filter
      rows = rows.filter(r => r.best_mos != null);
      if (uvOnly) rows = rows.filter(r => r.undervalued && r.best_mos >= minMos);

      // Sort
      const key = els.sortBy.value;
      const asc = els.asc.checked;
      rows.sort((a,b) => {
        const av = a[key]; const bv = b[key];
        if (av==null && bv==null) return 0;
        if (av==null) return asc ? -1 : 1;
        if (bv==null) return asc ? 1 : -1;
        if (av < bv) return asc ? -1 : 1;
        if (av > bv) return asc ? 1 : -1;
        return 0;
      });

      // Limit
      const lim = Math.max(5, Math.min(5000, parseInt(els.limit.value||"50")));
      filtered = rows.slice(0, lim);

      // Render
      renderTable(minMos);
      renderHeader(minMos, uvOnly);
    }

    function renderHeader(minMos, uvOnly){
      const total = (payload.tickers || []).filter(r => r.best_mos != null).length;
      const uvCount = (payload.tickers || []).filter(r => r.undervalued && r.best_mos >= minMos).length;
      els.summary.textContent = `${uvCount} undervalued out of ${total} (threshold: ${Math.round(minMos*100)}%)`;
      const gen = payload.generated_at || "";
      els.generated.textContent = `Last updated: ${gen}`;
    }

    function renderTable(minMos){
      els.rows.innerHTML = "";
      for (const r of filtered){
        const tr = document.createElement('tr');
        tr.className = "border-b last:border-0 hover:bg-slate-50";
        const mos = r.best_mos;
        const mosClass = (mos != null && mos >= minMos) ? "text-green-600 font-medium" : (mos != null && mos < 0 ? "text-red-600 font-medium" : "text-slate-700");
        tr.innerHTML = `
          <td class="py-2 pr-4 font-semibold">${r.ticker}</td>
          <td class="py-2 pr-4 text-right tabular-nums">${fmtMoney(r.price)}</td>
          <td class="py-2 pr-4 text-right tabular-nums">${fmtMoney(r.best_fair_value)}</td>
          <td class="py-2 pr-4 text-right tabular-nums ${mosClass}">${fmtPct(mos)}</td>
          <td class="py-2 pr-4">${r.best_strategy || "-"}</td>
        `;
        els.rows.appendChild(tr);
      }
    }

    async function fetchOnce(){
      const url = `/results`;
      const res = await fetch(url, {cache: "no-store"});
      if (!res.ok){ throw new Error(`GET ${url} -> ${res.status}`); }
      payload = await res.json();
      // sync default MoS once from file
      if (payload.min_mos != null && !fetchOnce._synced){
        els.mos.value = payload.min_mos;
        els.mosVal.textContent = Math.round(payload.min_mos*100);
        fetchOnce._synced = true;
      }
      applyFilters();
    }

    function connectWs(){
      const proto = (location.protocol === "https:") ? "wss" : "ws";
      const ws = new WebSocket(`${proto}://${location.host}/stream`);
      ws.onopen = () => console.log("WS connected");
      ws.onmessage = (ev) => {
        try {
          payload = JSON.parse(ev.data);
          applyFilters();
          // ping back to keep alive
          try { ws.send("ping"); } catch(e){}
        } catch(e){ console.error(e); }
      };
      ws.onclose = () => {
        console.log("WS closed, retrying in 3s...");
        setTimeout(connectWs, 3000);
      };
      ws.onerror = () => ws.close();
    }

    // Events
    els.mos.addEventListener('input', () => { els.mosVal.textContent = Math.round(parseFloat(els.mos.value||"0")*100); applyFilters(); });
    els.uvOnly.addEventListener('change', applyFilters);
    els.sortBy.addEventListener('change', applyFilters);
    els.asc.addEventListener('change', applyFilters);
    els.limit.addEventListener('change', applyFilters);
    els.refreshBtn.addEventListener('click', fetchOnce);
    els.downloadCsv.addEventListener('click', () => {
      if (!filtered.length) return;
      const headers = ["ticker","price","best_fair_value","best_mos","best_strategy","undervalued"];
      const rows = filtered.map(r => headers.map(h => r[h]));
      const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
      const blob = new Blob([csv], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "ampyfin_val_filtered.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Init
    fetchOnce().catch(console.error);
    connectWs();
  </script>
</body>
</html>
